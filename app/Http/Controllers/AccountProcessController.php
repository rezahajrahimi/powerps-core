<?php
bolt_decrypt( __FILE__ , 'hLcQUC'); return 0;
##!!!##Cm5hbWVzcGFjZSBBcHBcSHR0cFxDb250cm9sbGVyczsKCnVzZSBBcHBcTW9kZWxzXEJvdFVzZXI7CnVzZSBBcHBcTW9kZWxzXFJlZmVycmFsTG9nczsKdXNlIEFwcFxNb2RlbHNcVHJhbnNhY3Rpb247CnVzZSBBcHBcTW9kZWxzXFRyYW5zYWN0aW9uU2V0dGluZzsKdXNlIEFwcFxNb2RlbHNcVXNlcjsKdXNlIEFwcFxNb2RlbHNcVXNlclN0YXRlOwp1c2UgQXBwXFNlcnZpY2VzXFRlbGVncmFtTWVzc2FnZUZvcm1hdHRlcjsKdXNlIEFwcFxTZXJ2aWNlc1xUZWxlZ3JhbVNlcnZpY2U7Ci8vIGFkZCBjYWNoZQp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcQ2FjaGU7Ci8vIGFkZCBSZXF1ZXN0CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKCi8vIGFkZCBjYWNoZQoKLy8gYWRkIEJvdFVzZXIgbW9kZWwKLy8gYWRkIGNhY2hlCgpjbGFzcyBBY2NvdW50UHJvY2Vzc0NvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsKICAgIHByaXZhdGUgVGVsZWdyYW1TZXJ2aWNlICR0ZWxlZ3JhbVNlcnZpY2U7CiAgICBwcml2YXRlIEN1c3RvbVRleHRDb250cm9sbGVyICRjdXN0b21UZXh0Q3RybDsKICAgIHByaXZhdGUgU3Vic2NyaXB0aW9uUHJvY2Vzc0NvbnRyb2xsZXIgJHN1YnNjcmlwdGlvblByb2Nlc3NDdHJsOwogICAgcHJpdmF0ZSBUcmFuc2FjdGlvbkNvbnRyb2xsZXIgJHRyYW5zYWN0aW9uQ250cmw7CiAgICBwcml2YXRlIEdlbmVyYWxDb250cm9sbGVyICRnZW5lcmFsQ250cmw7CiAgICBwcml2YXRlIFJlZmVycmFsV2FsbGV0Q29udHJvbGxlciAkcmVmZXJyYWxXYWxsZXRDdHJsOwogICAgcHJpdmF0ZSBBY2NvdW50QmFsbGFuY2VDb250cm9sbGVyICRhY2NCbEN0cmw7CiAgICBwcml2YXRlIEJvdFVzZXIgJGJvdFVzZXI7CiAgICBwcml2YXRlIExvZ0NvbnRyb2xsZXIgJGxvZ0N0cmw7CiAgICBwcml2YXRlICRjaGF0SWQ7CiAgICBwcml2YXRlIFRyYW5zYWN0aW9uQ29udHJvbGxlciAkdHJDbnRybDsKICAgIHByaXZhdGUgUGF5bWVudFR5cGVDb250cm9sbGVyICRweW1udENudHJsOwogICAgcHJpdmF0ZSBQYXltZW50TWVudUl0ZW1Db250cm9sbGVyICRweW1NZW5DbnRybDsKICAgIHByaXZhdGUgUGF5bWVudFNldHRpbmdDb250cm9sbGVyICRwYXltbmV0U2V0dGluZ0NudHJsOwogICAgcHJpdmF0ZSBTaGV0YWJWZXJpZnlDb250cm9sbGVyICRzaGV0YWJWZXJpZnlDbnRybDsKICAgIHB1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdChUZWxlZ3JhbVNlcnZpY2UgJHRlbGVncmFtU2VydmljZSkKICAgIHsKICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlICAgICAgICAgPSAkdGVsZWdyYW1TZXJ2aWNlOwogICAgICAgICR0aGlzLT5jdXN0b21UZXh0Q3RybCAgICAgICAgICA9IG5ldyBDdXN0b21UZXh0Q29udHJvbGxlcigpOwogICAgICAgICR0aGlzLT5zdWJzY3JpcHRpb25Qcm9jZXNzQ3RybCA9IG5ldyBTdWJzY3JpcHRpb25Qcm9jZXNzQ29udHJvbGxlcigkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlKTsKICAgICAgICAkdGhpcy0+dHJhbnNhY3Rpb25DbnRybCAgICAgICAgPSBuZXcgVHJhbnNhY3Rpb25Db250cm9sbGVyKCR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UpOwogICAgICAgICR0aGlzLT5nZW5lcmFsQ250cmwgICAgICAgICAgICA9IG5ldyBHZW5lcmFsQ29udHJvbGxlcigpOwogICAgICAgICR0aGlzLT5yZWZlcnJhbFdhbGxldEN0cmwgICAgICA9IG5ldyBSZWZlcnJhbFdhbGxldENvbnRyb2xsZXIoKTsKICAgICAgICAkdGhpcy0+YWNjQmxDdHJsICAgICAgICAgICAgICAgPSBuZXcgQWNjb3VudEJhbGxhbmNlQ29udHJvbGxlcigpOwogICAgICAgICR0aGlzLT5ib3RVc2VyICAgICAgICAgICAgICAgICA9IG5ldyBCb3RVc2VyKCk7CiAgICAgICAgJHRoaXMtPmxvZ0N0cmwgICAgICAgICAgICAgICAgID0gbmV3IExvZ0NvbnRyb2xsZXIoKTsKICAgICAgICAkdGhpcy0+cHltbnRDbnRybCAgICAgICAgICAgICAgPSBuZXcgUGF5bWVudFR5cGVDb250cm9sbGVyKCk7CiAgICAgICAgJHRoaXMtPnB5bU1lbkNudHJsICAgICAgICAgICAgID0gbmV3IFBheW1lbnRNZW51SXRlbUNvbnRyb2xsZXIoKTsKICAgICAgICAkdGhpcy0+dHJDbnRybCAgICAgICAgICAgICAgICAgPSBuZXcgVHJhbnNhY3Rpb25Db250cm9sbGVyKCk7CiAgICAgICAgJHRoaXMtPnBheW1uZXRTZXR0aW5nQ250cmwgICAgID0gbmV3IFBheW1lbnRTZXR0aW5nQ29udHJvbGxlcigpOwogICAgICAgICR0aGlzLT5zaGV0YWJWZXJpZnlDbnRybCAgICAgICA9IG5ldyBTaGV0YWJWZXJpZnlDb250cm9sbGVyKCk7CiAgICB9CiAgICBwdWJsaWMgZnVuY3Rpb24gYWNjb3VudERldGFpbHMoJGNoYXRJZCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGhpcy0+Y2hhdElkID0gJGNoYXRJZDsKICAgICAgICAgICAgJGJvdFVzZXIgICAgICA9IEJvdFVzZXI6OndoZXJlKCdhY2NvdW50X2lkJywgJGNoYXRJZCktPmZpcnN0KCk7CiAgICAgICAgICAgIGlmICgkYm90VXNlciA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmdlbmVyYWxDbnRybC0+cmV0dXJuX21haW5fbWVudV9pdGVtcygkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2Vycm9yLnVzZXJfbm90X2ZvdW5kJykpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkYmFsbGFuY2UgICAgICAgICA9ICR0aGlzLT5hY2NCbEN0cmwtPmdldFVzZXJBY2N1bnRCYWxhbmNlKCRjaGF0SWQpOwogICAgICAgICAgICAkYmFsbGFuY2VJbkRvbGxhciA9ICR0aGlzLT5hY2NCbEN0cmwtPmdldFVzZXJBY2N1bnRCYWxhbmNlSW5Eb2xsYXIoJGNoYXRJZCk7CiAgICAgICAgICAgICRyZWZlcnJhbEFtb3VudCAgID0gJHRoaXMtPnJlZmVycmFsV2FsbGV0Q3RybC0+Z2V0X2Ftb3VudF9vZl9yZWZfd2FsbGV0X2J5X2FjY291bnRfaWQoJGNoYXRJZCk7CiAgICAgICAgICAgICRiYWxsYW5jZSAgICAgICAgID0gbnVtYmVyX2Zvcm1hdCgkYmFsbGFuY2UsIDAsICcuJywgJywnKTsKICAgICAgICAgICAgJGJhbGxhbmNlSW5Eb2xsYXIgPSBudW1iZXJfZm9ybWF0KCRiYWxsYW5jZUluRG9sbGFyLCAwLCAnLicsICcsJyk7CiAgICAgICAgICAgICRyZWZlcnJhbEFtb3VudCAgID0gbnVtYmVyX2Zvcm1hdCgkcmVmZXJyYWxBbW91bnQsIDAsICcuJywgJywnKTsKICAgICAgICAgICAgJHRleHQgICAgICAgICAgICAgPSAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5hY2NvdW50LmRldGFpbHMnLCBbCiAgICAgICAgICAgICAgICAndXNlcm5hbWUnICAgICAgICAgID0+ICRib3RVc2VyLT51c2VybmFtZSwKICAgICAgICAgICAgICAgICduYW1lJyAgICAgICAgICAgICAgPT4gJGJvdFVzZXItPmZpcnN0X25hbWUsCiAgICAgICAgICAgICAgICAnbGFzdF9uYW1lJyAgICAgICAgID0+ICRib3RVc2VyLT5sYXN0X25hbWUsCiAgICAgICAgICAgICAgICAnYWNjb3VudF9pZCcgICAgICAgID0+ICRib3RVc2VyLT5hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgJ2JhbGFuY2UnICAgICAgICAgICA9PiAiJGJhbGxhbmNlINiq2YjZhdin2YYiLAogICAgICAgICAgICAgICAgJ2JhbGFuY2VfaW5fZG9sbGFyJyA9PiAiJGJhbGxhbmNlSW5Eb2xsYXIg2K/ZhNin2LEiLAogICAgICAgICAgICAgICAgJ3JlZmVycmFsX2JhbGFuY2UnICA9PiAiJHJlZmVycmFsQW1vdW50INiq2YjZhdin2YYiLAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICRmb3JtYXR0ZXIgPSBuZXcgVGVsZWdyYW1NZXNzYWdlRm9ybWF0dGVyKCR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UpOwogICAgICAgICAgICAkdGV4dCAgICAgID0gJGZvcm1hdHRlci0+YWRkRm9ybWF0dGVkVGV4dCgnJywgJHRleHQpLT5nZXRNZXNzYWdlKCk7CgogICAgICAgICAgICAkdGhpcy0+Z2VuZXJhbENudHJsLT5yZXR1cm5fbWFpbl9tZW51X2l0ZW1zKCRjaGF0SWQsICR0ZXh0KTsKICAgICAgICAgICAgJHRoaXMtPnNob3dfYWRkaXRpb25hbF9vcHRpb25zKCRjaGF0SWQpOwogICAgICAgICAgICAkdGhpcy0+YWRkTmV3Qm90TG9nKCdhY2NvdW50JywgJ9mI2KfYsdivINio2K7YtCDYrNiy2KbbjNin2Kog2K3Ys9in2Kgg2LTYry4nLCAnc2hvdycpOwogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgXExvZzo6ZXJyb3IoWyJhY2NvdW50RGV0YWlsczogIiAuICR0aF0pOwogICAgICAgICAgICAkdGhpcy0+Y2xlYXJBd2FpdGluZ1JlcGx5KCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnZXJyb3Iuc2VydmVyX2Vycm9yJykpOwogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfQogICAgcHJpdmF0ZSBmdW5jdGlvbiBzaG93X2FkZGl0aW9uYWxfb3B0aW9ucygkY2hhdElkKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRvcHIgID0gW107CiAgICAgICAgICAgICR0ZXh0ID0gJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24uYWNjb3VudC5hZGRpdGlvbmFsX29wdGlvbnMudHJhbnNhY3Rpb25zJyk7CiAgICAgICAgICAgIGlmIChpc19hcnJheSgkdGV4dCkpIHsKICAgICAgICAgICAgICAgIC8vIHVzZSBmb3JtYXQgdGV4dCBzZXJ2aWNlCiAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPmZvcm1hdFRleHQoJHRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRvcHJbXSA9IFsKICAgICAgICAgICAgICAgICR0ZXh0ID0+ICJhY2NvdW50VHJhbnNhY3Rpb25zIiwKICAgICAgICAgICAgXTsKICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5hY2NvdW50LmFkZGl0aW9uYWxfb3B0aW9ucy5zdWJfYWNjb3VudHMnKTsKICAgICAgICAgICAgaWYgKGlzX2FycmF5KCR0ZXh0KSkgewogICAgICAgICAgICAgICAgLy8gdXNlIGZvcm1hdCB0ZXh0IHNlcnZpY2UKICAgICAgICAgICAgICAgICR0ZXh0ID0gJHRoaXMtPnRlbGVncmFtU2VydmljZS0+Zm9ybWF0VGV4dCgkdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJG9wcltdID0gWwogICAgICAgICAgICAgICAgJHRleHQgPT4gImFjY291bnRTdWJBY2NvdW50cyIsCiAgICAgICAgICAgIF07CgogICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLmFjY291bnQuYWRkaXRpb25hbF9vcHRpb25zLmFkZF9iYWxhbmNlJyk7CiAgICAgICAgICAgIGlmIChpc19hcnJheSgkdGV4dCkpIHsKICAgICAgICAgICAgICAgIC8vIHVzZSBmb3JtYXQgdGV4dCBzZXJ2aWNlCiAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPmZvcm1hdFRleHQoJHRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRvcHJbXSA9IFsKICAgICAgICAgICAgICAgICR0ZXh0ID0+ICJhY2NvdW50QWRkQmFsYW5jZSIsCiAgICAgICAgICAgIF07CiAgICAgICAgICAgICR0ZXh0ID0gJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24uYWNjb3VudC5hZGRpdGlvbmFsX29wdGlvbnMnKTsKCiAgICAgICAgICAgICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPnNlbmRNZXNzYWdlV2l0aElubGluZUtleWJvYXJkKCRjaGF0SWQsICR0ZXh0LCAkb3ByKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIFxMb2c6OmVycm9yKFsic2hvd19hZGRpdGlvbmFsX29wdGlvbnM6ICIgLiAkdGhdKTsKICAgICAgICAgICAgJHRoaXMtPmNsZWFyQXdhaXRpbmdSZXBseSgkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2Vycm9yLnNlcnZlcl9lcnJvcicpKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0KICAgIHB1YmxpYyBmdW5jdGlvbiBhY2NvdW50VHJhbnNhY3Rpb25zKCRjaGF0SWQpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRoaXMtPmNoYXRJZCA9ICRjaGF0SWQ7CiAgICAgICAgICAgIC8vICR0aGlzLT5zaG93X2FkZGl0aW9uYWxfb3B0aW9ucygkY2hhdElkKTsKICAgICAgICAgICAgJHRoaXMtPmFkZE5ld0JvdExvZygnYWNjb3VudCcsICfZiNin2LHYryDYqNiu2LQg2LPYp9io2YLZhyDYqtix2KfaqdmG2LTigIzZh9inINi02K8uJywgJ3Nob3cnKTsKICAgICAgICAgICAgJGJvdFVzZXIgPSBCb3RVc2VyOjp3aGVyZSgnYWNjb3VudF9pZCcsICRjaGF0SWQpLT5maXJzdCgpOwogICAgICAgICAgICBpZiAoJGJvdFVzZXIgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5nZW5lcmFsQ250cmwtPnJldHVybl9tYWluX21lbnVfaXRlbXMoJGNoYXRJZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdlcnJvci5zZXJ2ZXJfZXJyb3InKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICR0cmFuc2FjdGlvbnMgPSBUcmFuc2FjdGlvbjo6d2hlcmUoJ2FjY291bnRfaWQnLCAkYm90VXNlci0+YWNjb3VudF9pZCktPmdldCgpOwogICAgICAgICAgICAkdHJhbnNhY3Rpb25zID0gJHRyYW5zYWN0aW9ucy0+c29ydEJ5RGVzYygnY3JlYXRlZF9hdCcpOwogICAgICAgICAgICAkdHJhbnNhY3Rpb25zID0gJHRyYW5zYWN0aW9ucy0+dGFrZSgxMCk7CiAgICAgICAgICAgICR0ZXh0ICAgICAgICAgPSAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5hY2NvdW50LnRyYW5zYWN0aW9ucy50aXRsZScpOwogICAgICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZSgkY2hhdElkLCAkdGV4dCk7CiAgICAgICAgICAgICR0ZXh0ID0gIiI7CiAgICAgICAgICAgIGlmICgkdHJhbnNhY3Rpb25zLT5jb3VudCgpID4gMCkgewogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHRyYW5zYWN0aW9ucyBhcyAkdHJhbnNhY3Rpb24pIHsKCiAgICAgICAgICAgICAgICAgICAgJHRleHQgLj0gJHRyYW5zYWN0aW9uLT5nZXRUcmFuc2FjdGlvblRleHQoKSAuICJcbiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLmFjY291bnQudHJhbnNhY3Rpb25zLm5vX3RyYW5zYWN0aW9ucycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZSgkY2hhdElkLCAkdGV4dCk7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBcTG9nOjplcnJvcihbImFjY291bnRUcmFuc2FjdGlvbnM6ICIgLiAkdGhdKTsKICAgICAgICAgICAgJHRoaXMtPmNsZWFyQXdhaXRpbmdSZXBseSgkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2Vycm9yLnNlcnZlcl9lcnJvcicpKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0KICAgIHB1YmxpYyBmdW5jdGlvbiBhY2NvdW50U3ViQWNjb3VudHMoJGNoYXRJZCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyB0b2RvIGNoZWNrIG9uIHByb2R1Y3Rpb24KICAgICAgICAgICAgJHRoaXMtPmNoYXRJZCA9ICRjaGF0SWQ7CiAgICAgICAgICAgICR0aGlzLT5hZGROZXdCb3RMb2coJ2FjY291bnQnLCAn2YjYp9ix2K8g2KjYrti0INiy24zYsSDZhdis2YXZiNi52Ycg2YfYpyDYtNivLicsICdzaG93Jyk7CiAgICAgICAgICAgICRib3RVc2VyID0gQm90VXNlcjo6d2hlcmUoJ2FjY291bnRfaWQnLCAkY2hhdElkKS0+Zmlyc3QoKTsKICAgICAgICAgICAgaWYgKCRib3RVc2VyID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+Z2VuZXJhbENudHJsLT5yZXR1cm5fbWFpbl9tZW51X2l0ZW1zKCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnZXJyb3Iuc2VydmVyX2Vycm9yJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRzdWJBY2NvdW50cyA9IFJlZmVycmFsTG9nczo6d2hlcmUoJ3JlZmVycmFsX3VzZXJfaWQnLCAkYm90VXNlci0+aWQpLT5nZXQoKTsKICAgICAgICAgICAgJHRleHQgICAgICAgID0gJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24uYWNjb3VudC5zdWJfYWNjb3VudHMudGl0bGUnKTsKICAgICAgICAgICAgJHRoaXMtPnRlbGVncmFtU2VydmljZS0+c2VuZE1lc3NhZ2UoJGNoYXRJZCwgJHRleHQpOwogICAgICAgICAgICAkdGV4dCA9ICIiOwoKICAgICAgICAgICAgaWYgKCRzdWJBY2NvdW50cy0+Y291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRzdWJBY2NvdW50cyBhcyAkc3ViQWNjb3VudCkgewogICAgICAgICAgICAgICAgICAgICR0ZXh0IC49ICRzdWJBY2NvdW50LT5nZXRSZWZlcnJhbExvZ3NUZXh0KCkgLiAiXG4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5hY2NvdW50LnN1Yl9hY2NvdW50cy5ub19zdWJfYWNjb3VudHMnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZSgkY2hhdElkLCAkdGV4dCk7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBcTG9nOjplcnJvcihbImFjY291bnRTdWJBY2NvdW50czogIiAuICR0aF0pOwogICAgICAgICAgICAkdGhpcy0+Y2xlYXJBd2FpdGluZ1JlcGx5KCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnZXJyb3Iuc2VydmVyX2Vycm9yJykpOwogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfQogICAgcHVibGljIGZ1bmN0aW9uIGFjY291bnRBZGRCYWxhbmNlKCRjaGF0SWQsICRhY3Rpb25MaXN0ID0gbnVsbCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGhpcy0+Y2hhdElkID0gJGNoYXRJZDsKICAgICAgICAgICAgJHRoaXMtPmFkZE5ld0JvdExvZygnYWNjb3VudCcsICfZiNin2LHYryDYqNiu2LQg2KfZgdiy2KfbjNi0INin2LnYqtio2KfYsSDYrdiz2KfYqCDYtNivLicsICdzaG93Jyk7IC8vIGNoZWNrIGlmIGFjdGlvbkxpc3QgaXMgYXJyYXkgYW5kIGhhdmUgbm90IG1vcmUgdGhhbiAxICBlbGVtZW50cwoKICAgICAgICAgICAgJHRoaXMtPnJldHVybl9wYXltZW50X29wdGlvbnMoKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIFxMb2c6OmVycm9yKFsiYWNjb3VudEFkZEJhbGFuY2U6ICIgLiAkdGhdKTsKICAgICAgICAgICAgJHRoaXMtPmNsZWFyQXdhaXRpbmdSZXBseSgkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2Vycm9yLnNlcnZlcl9lcnJvcicpKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0KICAgIHByaXZhdGUgZnVuY3Rpb24gcmV0dXJuX3BheW1lbnRfb3B0aW9ucygpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJG9wciA9IFtdOwoKICAgICAgICAgICAgJGhhc1phcmluUGFsID0gJHRoaXMtPnB5bW50Q250cmwtPmdldFphcmlucGFsU3RhdHVzKCk7CiAgICAgICAgICAgIGlmICgkaGFzWmFyaW5QYWwgPT0gdHJ1ZSB8fCAkaGFzWmFyaW5QYWwgPT0gMSkgewogICAgICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5wcm9jZXNzLmFkZF9vbmxpbmVfYmFsYW5jZS56YXJpbnBhbCcpOwogICAgICAgICAgICAgICAgaWYgKGlzX2FycmF5KCR0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIC8vIHVzZSBmb3JtYXQgdGV4dCBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5mb3JtYXRUZXh0KCR0ZXh0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkbmV3T3ByID0gWwogICAgICAgICAgICAgICAgICAgICR0ZXh0ID0+ICJhY2NvdW50U3ViQWNjb3VudHNaYXJpbnBhbCIsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkb3ByLCAkbmV3T3ByKTsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICRoYXNEb2xsYXJQYXkgPSAkdGhpcy0+cGF5bW5ldFNldHRpbmdDbnRybC0+Z2V0UGF5bWVudFNldHRpbmdTdGF0dXNCeUtleSgndXNkX3RyYW5zYWN0aW9uJyk7CiAgICAgICAgICAgIGlmICgkaGFzRG9sbGFyUGF5ID09IHRydWUgfHwgJGhhc0RvbGxhclBheSA9PSAxKSB7CiAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLnByb2Nlc3MuYWRkX29ubGluZV9iYWxhbmNlLmRvbGxhcnBheS5ub3dwYXltZW50Jyk7CiAgICAgICAgICAgICAgICBpZiAoaXNfYXJyYXkoJHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGZvcm1hdCB0ZXh0IHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPmZvcm1hdFRleHQoJHRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJG5ld09wciA9IFsKICAgICAgICAgICAgICAgICAgICAkdGV4dCA9PiAiYWNjb3VudFN1YkFjY291bnRzTm93cGF5bWVudCIsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkb3ByLCAkbmV3T3ByKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY291bnQoJG9wcikgPiAwKSB7CiAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLnByb2Nlc3MuYWRkX29ubGluZV9iYWxhbmNlJyk7CiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiB0aGUgdGV4dCBpcyBqc29uIGZvcm1hdAoKICAgICAgICAgICAgICAgICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPnNlbmRNZXNzYWdlV2l0aElubGluZUtleWJvYXJkKCR0aGlzLT5jaGF0SWQsICR0ZXh0LCAkb3ByKTsKICAgICAgICAgICAgfQoKLy8gc2VuZCBvZmZsaW5lIGl0ZW0KICAgICAgICAgICAgJG9wciA9IFtdOwogICAgICAgICAgICAvLyBjaGVjayBwYXltZW50IHNldHRpbmcgZm9yIHNoZXRhYiB2ZXJpZnkKICAgICAgICAgICAgJHNoZXRhYlZlcmlmeVN0YXR1cyA9ICR0aGlzLT5zaGV0YWJWZXJpZnlDbnRybC0+Y2hlY2tfc2hldGFiX3ZlcmlmeV9zdGF0dXMoKTsKICAgICAgICAgICAgaWYgKCRzaGV0YWJWZXJpZnlTdGF0dXMgPT0gdHJ1ZSB8fCAkc2hldGFiVmVyaWZ5U3RhdHVzID09IDEpIHsKICAgICAgICAgICAgICAgIC8vICR0ZXh0ID0gJHRoaXMtPnBheW1uZXRTZXR0aW5nQ250cmwtPmdldFBheW1lbnRTZXR0aW5nRGVzY3JpcHRpb25CeUtleSgnc2hldGFiX3ZlcmlmeScpOwogICAgICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5wcm9jZXNzLmFkZF9vbmxpbmVfYmFsYW5jZS5zaGV0YWJfdmVyaWZ5Jyk7CiAgICAgICAgICAgICAgICBpZiAoaXNfYXJyYXkoJHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdXNlIGZvcm1hdCB0ZXh0IHNlcnZpY2UKICAgICAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPmZvcm1hdFRleHQoJHRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJG9wcltdID0gWwogICAgICAgICAgICAgICAgICAgICR0ZXh0ID0+ICJzaGV0YWJWZXJpZnktYWRkQmFsYW5jZSIsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CgoKCiAgICAgICAgICAgICRvZmZsaW5lUGF5bWVudCA9ICR0aGlzLT5weW1udENudHJsLT5nZXRBbGxBY3RpdmVPZmZsaW5lUGF5bWVudFR5cGVzKCk7CiAgICAgICAgICAgIGlmICgkb2ZmbGluZVBheW1lbnQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCRoYXNaYXJpblBhbCA9PSB0cnVlIHx8ICRoYXNaYXJpblBhbCA9PSAxIHx8ICRoYXNEb2xsYXJQYXkgPT0gdHJ1ZSB8fCAkaGFzRG9sbGFyUGF5ID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAkdGV4dCA9ICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLnByb2Nlc3MuYWRkX29mZmxpbmVfYmFsYW5jZV9vcHRpb25fYW5kX29ubGluZV9iYWxhbmNlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICR0ZXh0ID0gJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24ucHJvY2Vzcy5hZGRfb2ZmbGluZV9iYWxhbmNlX29wdGlvbicpOwogICAgICAgICAgICAgICAgfQoKCgogICAgICAgICAgICAgICAgZm9yZWFjaCAoJG9mZmxpbmVQYXltZW50IGFzICRrZXkgPT4gJHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgJG9wcltdID0gWwogICAgICAgICAgICAgICAgICAgICAgICAiJHZhbHVlLT5uYW1lIiA9PiAib2ZmbGluZUdhdGV3YXktJHZhbHVlLT5pZCAiLAogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CiAgICAgICAgICAgICR0ZXh0ID0gJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24ucHJvY2Vzcy5hZGRfb2ZmbGluZV9iYWxhbmNlX29wdGlvbicpOwoKICAgICAgICAgICAgJHRoaXMtPnRlbGVncmFtU2VydmljZS0+c2VuZE1lc3NhZ2VXaXRoSW5saW5lS2V5Ym9hcmQoJHRoaXMtPmNoYXRJZCwgJHRleHQsICRvcHIpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgXExvZzo6ZXJyb3IoWyJyZXR1cm5fcGF5bWVudF9vcHRpb25zOiAiIC4gJHRoXSk7CiAgICAgICAgICAgICR0aGlzLT5jbGVhckF3YWl0aW5nUmVwbHkoJGNoYXRJZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdlcnJvci5zZXJ2ZXJfZXJyb3InKSk7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9CiAgICBwdWJsaWMgZnVuY3Rpb24gaGFuZGxlQWN0aW9uQWRkQmFsYW5jZVphcmlucGFsKHN0cmluZyAkY2hhdElkKTogc3RyaW5nCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRoaXMtPnNldEF3YWl0aW5nUmVwbHkoJGNoYXRJZCwgJ2FkZF9iYWxhbmNlX3JlcGx5JywgJ3phcmlucGFsJyk7CiAgICAgICAgICAgICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPmZvcmNlUmVwbHkoJGNoYXRJZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24ucHJvY2Vzcy5hZGRfb25saW5lX2JhbGFuY2UuemFyaW5wYWwucmVwbHknKSk7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBcTG9nOjplcnJvcihbImhhbmRsZUFjdGlvbkFkZEJhbGFuY2VaYXJpbnBhbDogIiAuICR0aF0pOwogICAgICAgICAgICAkdGhpcy0+Y2xlYXJBd2FpdGluZ1JlcGx5KCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnZXJyb3Iuc2VydmVyX2Vycm9yJykpOwogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfQogICAgcHVibGljIGZ1bmN0aW9uIGhhbmRsZUFjdGlvbkFkZEJhbGFuY2VOb3dwYXltZW50cyhzdHJpbmcgJGNoYXRJZCk6IHN0cmluZwogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0aGlzLT5zZXRBd2FpdGluZ1JlcGx5KCRjaGF0SWQsICdhZGRfYmFsYW5jZV9yZXBseScsICdub3dwYXltZW50cycpOwogICAgICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5mb3JjZVJlcGx5KCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLnByb2Nlc3MuYWRkX29ubGluZV9iYWxhbmNlLm5vd3BheW1lbnRzLnJlcGx5JykpOwogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgXExvZzo6ZXJyb3IoWyJoYW5kbGVBY3Rpb25BZGRCYWxhbmNlTm93cGF5bWVudHM6ICIgLiAkdGhdKTsKICAgICAgICAgICAgJHRoaXMtPmNsZWFyQXdhaXRpbmdSZXBseSgkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2Vycm9yLnNlcnZlcl9lcnJvcicpKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0KICAgIHB1YmxpYyBmdW5jdGlvbiBhZGRCYWxhbmNlUmVwbHkoc3RyaW5nICRjaGF0SWQsIHN0cmluZyAkdGV4dCk6IHN0cmluZwogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRleHQgaXMgdmFsaWQgaW50IG9yIGZsb2F0CiAgICAgICAgICAgIGlmICghIGlzX251bWVyaWMoJHRleHQpKSB7CiAgICAgICAgICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZSgkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5wcm9jZXNzLmFkZF9vbmxpbmVfYmFsYW5jZS56YXJpbnBhbC5yZXBseS5pbnZhbGlkX2Ftb3VudCcpKTsKICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJHRleHQgPT0gbnVsbCB8fCB0cmltKCR0ZXh0KSA9PSAn2YTYutmIJyB8fCB0cmltKCR0ZXh0KSA9PSAnY2FuY2VsJykgewogICAgICAgICAgICAgICAgJHRoaXMtPmNsZWFyQXdhaXRpbmdSZXBseSgkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5wcm9jZXNzLnJlcGx5LmNhbmNlbCcpKTsKICAgICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICAkdXNlcl9zdGF0ZSAgPSBVc2VyU3RhdGU6OndoZXJlKCdjaGF0X2lkJywgJGNoYXRJZCktPmxhdGVzdCgpLT5maXJzdCgpOwogICAgICAgICAgICAkcGF5bWVudFR5cGUgPSAkdXNlcl9zdGF0ZS0+ZGF0YTsKICAgICAgICAgICAgaWYgKCRwYXltZW50VHlwZSA9PSAnemFyaW5wYWwnKSB7CiAgICAgICAgICAgICAgICAvLyB6YXJpbnBhbCA9PiBjcmVhdGUgYSBuZXcgaW52b2ljZSB3aXRoIGFtb3VudAogICAgICAgICAgICAgICAgJG9wciAgPSBbXTsKICAgICAgICAgICAgICAgICRsaW5rID0gJHRoaXMtPmdlbmVyYWxDbnRybC0+Y3JlYXRlWmFyaW5wYWxQYXltZW50TGluaygkY2hhdElkLCAkdGV4dCk7CiAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRvcHIsICRsaW5rKTsKICAgICAgICAgICAgICAgICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPnNlbmRNZXNzYWdlV2l0aExpbmtCdXR0b25zKCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLnByb2Nlc3MuYWRkX29ubGluZV9iYWxhbmNlLnphcmlucGFsLnJlcGx5Lmludm9pY2UnKSwgJG9wcik7CgogICAgICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5wcm9jZXNzLmFkZF9vbmxpbmVfYmFsYW5jZS56YXJpbnBhbC5yZXBseScpOwogICAgICAgICAgICAgICAgaWYgKGlzX2FycmF5KCR0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIC8vIHVzZSBmb3JtYXQgdGV4dCBzZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5mb3JtYXRUZXh0KCR0ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICR0aGlzLT5jbGVhckF3YWl0aW5nUmVwbHkoJGNoYXRJZCwgJHRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9IGVsc2VpZiAoJHBheW1lbnRUeXBlID09ICJub3dwYXltZW50cyIpIHsKICAgICAgICAgICAgICAgICRvcHIgID0gW107CiAgICAgICAgICAgICAgICAkbGluayA9ICR0aGlzLT5nZW5lcmFsQ250cmwtPmNyZWF0ZU5vd1BheW1lbnRzTGluaygkY2hhdElkLCAkdGV4dCk7CiAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRvcHIsICRsaW5rKTsKCiAgICAgICAgICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZVdpdGhMaW5rQnV0dG9ucygkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5wcm9jZXNzLmFkZF9vbmxpbmVfYmFsYW5jZS5ub3dwYXltZW50cy5yZXBseS5pbnZvaWNlJyksICRvcHIpOwogICAgICAgICAgICAgICAgcmV0dXJuICIiOwoKICAgICAgICAgICAgfSBlbHNlaWYgKCRwYXltZW50VHlwZSA9PSAic2hldGFiX3ZlcmlmeSIpIHsKICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBhIG5ldyBpbnZvaWNlIHdpdGggYW1vdW50CiAgICAgICAgICAgICAgICAkdGhpcy0+cHJvY2Vzc1NoZXRhYlZlcmlmaWNhdGlvbigkY2hhdElkLCAkdGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJHRoaXMtPmNsZWFyQXdhaXRpbmdSZXBseSgkY2hhdElkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2FjdGlvbi5wcm9jZXNzLmFkZF9vbmxpbmVfYmFsYW5jZS56YXJpbnBhbC5yZXBseScpKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIFxMb2c6OmVycm9yKFsiYWRkQmFsYW5jZVJlcGx5OiAiIC4gJHRoXSk7CiAgICAgICAgICAgICR0aGlzLT5jbGVhckF3YWl0aW5nUmVwbHkoJGNoYXRJZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdlcnJvci5zZXJ2ZXJfZXJyb3InKSk7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGFkbWluRmFzdENoYXJnZSgkY2hhdF9pZCwgJGFtb3VudCwgJHVzZXJfaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRoaXMtPmNoYXRJZCA9ICRjaGF0X2lkOwogICAgICAgICAgICAkdXNlciAgICAgICAgID0gVXNlcjo6d2hlcmUoJ2FjY291bnRfaWQnLCAkY2hhdF9pZCktPmZpcnN0KCk7CiAgICAgICAgICAgIGlmICgkdXNlciA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPnRlbGVncmFtU2VydmljZS0+c2VuZE1lc3NhZ2UoJGNoYXRfaWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnZXJyb3IudXNlcl9ub3RfZm91bmQnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCR1c2VyLT5yb2xlICE9ICdhZG1pbicpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZSgkY2hhdF9pZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdlcnJvci51c2VyX25vdF9mb3VuZCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyDYqNix2LHYs9uMINmF2LnYqtio2LEg2KjZiNiv2YYg2YXZgtiv2KfYsQogICAgICAgICAgICBpZiAoISBpc19udW1lcmljKCRhbW91bnQpIHx8ICRhbW91bnQgPD0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPnNlbmRNZXNzYWdlKCRjaGF0X2lkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2Vycm9yLmludmFsaWRfYW1vdW50JykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vINm+24zYr9inINqp2LHYr9mGINqp2KfYsdio2LEKICAgICAgICAgICAgJGJvdFVzZXIgPSBCb3RVc2VyOjp3aGVyZSgnYWNjb3VudF9pZCcsICR1c2VyX2lkKS0+Zmlyc3QoKTsKICAgICAgICAgICAgaWYgKCRib3RVc2VyID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZSgkY2hhdF9pZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdlcnJvci51c2VyX25vdF9mb3VuZCcpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8g2KfZgdiy2KfbjNi0INmF2YjYrNmI2K/bjCDYrdiz2KfYqAogICAgICAgICAgICAkdGhpcy0+YWNjQmxDdHJsLT5pbmNVc2VyQWNjdW50QmFsYW5jZSgkdXNlcl9pZCwgJGFtb3VudCk7CiAgICAgICAgICAgIC8vINir2KjYqiDZhNin2q8KICAgICAgICAgICAgJHRoaXMtPmFkZE5ld0JvdExvZygnYWRtaW4nLCAi2LTYp9ix2pgg2LPYsduM2Lkg2K3Ys9in2Kgg2qnYp9ix2KjYsSB7JHVzZXJfaWR9INio2Ycg2YXYqNmE2LogeyRhbW91bnR9INiq2YjZhdin2YYiLCAnY2hhcmdlJyk7CgogICAgICAgICAgICAvLyDYp9ix2LPYp9mEINm+24zYp9mFINmF2YjZgdmC24zYqiDYqNmHINin2K/ZhduM2YYKICAgICAgICAgICAgJHRoaXMtPnRlbGVncmFtU2VydmljZS0+c2VuZE1lc3NhZ2UoJGNoYXRfaWQsICLYrdiz2KfYqCDaqdin2LHYqNixIHskdXNlcl9pZH0g2KjYpyDZhdmI2YHZgtuM2Kog2KjZhyDZhdio2YTYuiB7JGFtb3VudH0g2KrZiNmF2KfZhiDYtNin2LHamCDYtNivLiIpOwoKICAgICAgICAgICAgLy8g2KfYsdiz2KfZhCDZvtuM2KfZhSDYqNmHINqp2KfYsdio2LEKICAgICAgICAgICAgJHRoaXMtPnRlbGVncmFtU2VydmljZS0+c2VuZE1lc3NhZ2UoJHVzZXJfaWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnYWN0aW9uLmFjY291bnQuYmFsYW5jZV9hZGRlZCcsIFsKICAgICAgICAgICAgICAgICdhbW91bnQnID0+IG51bWJlcl9mb3JtYXQoJGFtb3VudCwgMCwgJy4nLCAnLCcpIC4gJyDYqtmI2YXYp9mGJywKICAgICAgICAgICAgXSkpOwogICAgICAgICAgICByZXR1cm4gIiI7CgogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIFxMb2c6OmVycm9yKFsiYWRtaW5GYXN0Q2hhcmdlOiAiIC4gJHRoXSk7CiAgICAgICAgICAgICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPnNlbmRNZXNzYWdlKCRjaGF0X2lkLCAkdGhpcy0+Y3VzdG9tVGV4dEN0cmwtPmdldFRleHQoJ2Vycm9yLnNlcnZlcl9lcnJvcicpKTsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0KICAgIHB1YmxpYyBmdW5jdGlvbiBoYW5kbGVBY3Rpb25BZGRCYWxhbmNlU2hldGFiVmVyaWZ5KHN0cmluZyAkY2hhdElkLCBzdHJpbmcgJHRleHQpCiAgICB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHRoaXMtPmNoYXRJZCA9ICRjaGF0SWQ7CiAgICAgICAgICAgICR0aGlzLT5zZXRBd2FpdGluZ1JlcGx5KCRjaGF0SWQsICdhZGRfYmFsYW5jZV9yZXBseScsICdzaGV0YWJfdmVyaWZ5Jyk7CiAgICAgICAgICAgICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPmZvcmNlUmVwbHkoJGNoYXRJZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24ucHJvY2Vzcy5hZGRfb25saW5lX2JhbGFuY2Uuc2hldGFiX3ZlcmlmeS5yZXBseScpKTsKICAgICAgICAgICAgcmV0dXJuICIiOwoKCiAgICAgICAgfSBjYXRjaCAoXFRocm93YWJsZSAkdGgpIHsKICAgICAgICAgICAgXExvZzo6ZXJyb3IoWyJoYW5kbGVBY3Rpb25BZGRCYWxhbmNlU2hldGFiVmVyaWZ5OiAiIC4gJHRoXSk7CiAgICAgICAgICAgICR0aGlzLT5jbGVhckF3YWl0aW5nUmVwbHkoJGNoYXRJZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdlcnJvci5zZXJ2ZXJfZXJyb3InKSk7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHNldEF3YWl0aW5nUmVwbHkoc3RyaW5nICRjaGF0SWQsIHN0cmluZyAkdHlwZSwgc3RyaW5nICRwYXltZW50VHlwZSk6IHZvaWQKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdXNlcl9zdGF0ZSAgICAgICAgICA9IG5ldyBVc2VyU3RhdGUoKTsKICAgICAgICAgICAgJHVzZXJfc3RhdGUtPmNoYXRfaWQgPSAkY2hhdElkOwogICAgICAgICAgICAkdXNlcl9zdGF0ZS0+c3RhdGUgICA9ICdhZGRfYmFsYW5jZV9yZXBseSc7CiAgICAgICAgICAgICR1c2VyX3N0YXRlLT5kYXRhICAgID0gJHBheW1lbnRUeXBlOwogICAgICAgICAgICAkdXNlcl9zdGF0ZS0+c2F2ZSgpOwoKICAgICAgICAgICAgLy8g2YXbjOKAjNiq2YjYp9mG24zYryDYp9iyINqp2LQg24zYpyDYr9uM2KrYp9io24zYsyDYp9iz2KrZgdin2K/ZhyDaqdmG24zYrwogICAgICAgICAgICBDYWNoZTo6cHV0KCJhd2FpdGluZ19yZXBseV97JGNoYXRJZH0iLCAkdHlwZSwgbm93KCktPmFkZE1pbnV0ZXMoNSkpOwogICAgICAgIH0gY2F0Y2ggKFxUaHJvd2FibGUgJHRoKSB7CiAgICAgICAgICAgIFxMb2c6OmVycm9yKFsic2V0QXdhaXRpbmdSZXBseTogIiAuICR0aF0pOwogICAgICAgIH0KICAgIH0KICAgIHByaXZhdGUgZnVuY3Rpb24gYXdhaXRpbmdSZXBseShzdHJpbmcgJGNoYXRJZCk6IGJvb2wKICAgIHsKICAgICAgICByZXR1cm4gQ2FjaGU6OmhhcygiYXdhaXRpbmdfcmVwbHlfeyRjaGF0SWR9Iik7CiAgICB9CiAgICBwcml2YXRlIGZ1bmN0aW9uIGdldEF3YWl0aW5nUmVwbHlUeXBlKHN0cmluZyAkY2hhdElkKTogP3N0cmluZwogICAgewogICAgICAgIHJldHVybiBDYWNoZTo6Z2V0KCJhd2FpdGluZ19yZXBseV97JGNoYXRJZH0iKTsKICAgIH0KICAgIHByaXZhdGUgZnVuY3Rpb24gY2xlYXJBd2FpdGluZ1JlcGx5KHN0cmluZyAkY2hhdElkLCBzdHJpbmcgfCBhcnJheSAkdGV4dCk6IHZvaWQKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAoaXNfYXJyYXkoJHRleHQpKSB7CiAgICAgICAgICAgICAgICAvLyB1c2UgZm9ybWF0IHRleHQgc2VydmljZQogICAgICAgICAgICAgICAgJHRleHQgPSAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5mb3JtYXRUZXh0KCR0ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDYWNoZTo6Zm9yZ2V0KCJhd2FpdGluZ19yZXBseV97JGNoYXRJZH0iKTsKICAgICAgICAgICAgLy8gY2xlYXIgYWxsIGNhY2hlCiAgICAgICAgICAgIENhY2hlOjpmbHVzaCgpOwogICAgICAgICAgICAvLyBkZWxldGUgbGFzdCB1c2VyIHN0YXRlIHdoZXJlIGNoYXRfaWQgPT0gJGNoYXRJZAogICAgICAgICAgICAkdXNlcl9zdGF0ZSA9IFVzZXJTdGF0ZTo6d2hlcmUoJ2NoYXRfaWQnLCAkY2hhdElkKS0+bGF0ZXN0KCktPmZpcnN0KCk7CiAgICAgICAgICAgIGlmICgkdXNlcl9zdGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAkdXNlcl9zdGF0ZS0+ZGVsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChcVGhyb3dhYmxlICR0aCkgewogICAgICAgICAgICBcTG9nOjplcnJvcihbImNsZWFyQXdhaXRpbmdSZXBseTogIiAuICR0aF0pOwogICAgICAgIH0KICAgIH0KICAgIHByaXZhdGUgZnVuY3Rpb24gYWRkTmV3Qm90TG9nKCR0eXBlLCAkbWVzc2FnZSwgJGV2ZW50KQogICAgewogICAgICAgICRsb2dDdHJsID0gbmV3IExvZ0NvbnRyb2xsZXIoKTsKICAgICAgICAkdGhpcy0+bG9nQ3RybC0+YWRkTmV3TG9nKCR0eXBlLCAkbWVzc2FnZSwgJHRoaXMtPmNoYXRJZCwgJHRoaXMtPmJvdFVzZXItPnVzZXJuYW1lLCAkZXZlbnQpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBwcm9jZXNzU2hldGFiVmVyaWZpY2F0aW9uKCRjaGF0SWQsICR0ZXh0KQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRyZXF1ZXN0ID0gbmV3IFJlcXVlc3QoKTsKICAgICAgICAgICAgJHJlcXVlc3QtPmFtb3VudCA9ICR0ZXh0OwogICAgICAgICAgICAkcmVxdWVzdC0+dXNlcl9pZCA9IFVzZXI6OndoZXJlKCdhY2NvdW50X2lkJywgJGNoYXRJZCktPmZpcnN0KCktPmlkOwoKICAgICAgICAgICAgJHNoZXRhYlZlcmlmeV9hbW91bnQgPSAkdGhpcy0+c2hldGFiVmVyaWZ5Q250cmwtPmNyZWF0ZV9uZXdfc2hldGFiX3ZlcmlmeSgkcmVxdWVzdCk7CgogICAgICAgICAgICBpZiAoJHNoZXRhYlZlcmlmeV9hbW91bnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFxMb2c6OmVycm9yKFsic2hldGFiVmVyaWZ5IGFtb3VudCBpcyBudWxsIl0pOwogICAgICAgICAgICAgICAgJHRoaXMtPnRlbGVncmFtU2VydmljZS0+c2VuZE1lc3NhZ2UoJGNoYXRJZCwgJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdlcnJvci5zZXJ2ZXJfZXJyb3InKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRtZXJjaGFudF9pZCA9ICR0aGlzLT5wYXltbmV0U2V0dGluZ0NudHJsLT5nZXRQYXltZW50U2V0dGluZ0Rlc2NyaXB0aW9uQnlLZXkoJ3NoZXRhYl92ZXJpZnknKTsKICAgICAgICAgICAgJG1lc3NhZ2VUZXh0ID0gJHRoaXMtPmN1c3RvbVRleHRDdHJsLT5nZXRUZXh0KCdhY3Rpb24ucHJvY2Vzcy5zaGV0YWJfdmVyaWZ5Lm5ld19pbnZvaWNlJywgWwogICAgICAgICAgICAgICAgJ21lcmNoYW50X2lkJyA9PiAkbWVyY2hhbnRfaWQsCiAgICAgICAgICAgICAgICAnYW1vdW50JyA9PiAkc2hldGFiVmVyaWZ5X2Ftb3VudCwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZiAoaXNfYXJyYXkoJG1lc3NhZ2VUZXh0KSkgewogICAgICAgICAgICAgICAgJG1lc3NhZ2VUZXh0ID0gJHRoaXMtPnRlbGVncmFtU2VydmljZS0+Zm9ybWF0VGV4dCgkbWVzc2FnZVRleHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkdGhpcy0+dGVsZWdyYW1TZXJ2aWNlLT5zZW5kTWVzc2FnZSgkY2hhdElkLCAkbWVzc2FnZVRleHQpOwogICAgICAgICAgICAkdGhpcy0+Y2xlYXJBd2FpdGluZ1JlcGx5KCRjaGF0SWQsICRtZXNzYWdlVGV4dCk7CgogICAgICAgICAgICByZXR1cm4gIiI7CgogICAgICAgIH0gY2F0Y2ggKFxFeGNlcHRpb24gJGUpIHsKICAgICAgICAgICAgXExvZzo6ZXJyb3IoIkVycm9yIGluIHByb2Nlc3NTaGV0YWJWZXJpZmljYXRpb246ICIgLiAkZSk7CiAgICAgICAgICAgICR0aGlzLT50ZWxlZ3JhbVNlcnZpY2UtPnNlbmRNZXNzYWdlKCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnZXJyb3Iuc2VydmVyX2Vycm9yJykpOwogICAgICAgICAgICAkdGhpcy0+Y2xlYXJBd2FpdGluZ1JlcGx5KCRjaGF0SWQsICR0aGlzLT5jdXN0b21UZXh0Q3RybC0+Z2V0VGV4dCgnZXJyb3Iuc2VydmVyX2Vycm9yJykpOwoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCn0K